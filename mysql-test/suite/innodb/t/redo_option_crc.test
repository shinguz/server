--source include/have_innodb.inc
--source include/have_debug.inc

call mtr.add_suppression("Page checksum stored in redo log record \\d+ does not match counted checksum \\d+ for page");

--let $i = 2

while ($i)
{

if ($i == 2)
{
--echo # Restart without redo log encryption
--let $restart_parameters=--skip-innodb-encrypt-log
--source include/restart_mysqld.inc
}
if ($i == 1)
{
--echo # Restart with redo log encryption
--let $restart_parameters=--innodb-encrypt-log=ON
--source include/restart_mysqld.inc
}

# Disable pages flushing to allow redo log records to be executed on --prepare.
SET GLOBAL debug_dbug="+d,ib_log_checkpoint_avoid";
SET GLOBAL innodb_page_cleaner_disabled_debug=ON;
SET GLOBAL innodb_redo_log_checksum=ON;
SET GLOBAL innodb_flush_log_at_trx_commit=1;
CREATE TABLE t(i INT) ENGINE INNODB;
INSERT INTO t VALUES (1);
CREATE TABLE t_page_comp(i INT) ENGINE INNODB  page_compressed=1;
INSERT INTO t_page_comp VALUES (1);
CREATE TABLE t_rf_comp(i INT) ENGINE INNODB row_format=compressed;
INSERT INTO t_rf_comp VALUES (1);
CREATE TABLE t_enc(i INT) ENGINE INNODB encrypted=yes;
INSERT INTO t_enc VALUES (1);
CREATE TABLE t_enc_page_comp(i INT) ENGINE INNODB page_compressed=yes encrypted=yes;
INSERT INTO t_enc_page_comp VALUES (1);
CREATE TABLE t_enc_rf_comp(i INT) ENGINE INNODB row_format=compressed encrypted=yes;
INSERT INTO t_enc_rf_comp VALUES (1);
--source include/kill_mysqld.inc
--source include/start_mysqld.inc
--let SEARCH_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
--let SEARCH_PATTERN=Page checksum stored in redo log record
--source include/search_pattern_in_file.inc

SET GLOBAL debug_dbug="+d,ib_log_checkpoint_avoid";
SET GLOBAL innodb_page_cleaner_disabled_debug=ON;
SET GLOBAL innodb_redo_log_checksum=ON;
SET GLOBAL innodb_flush_log_at_trx_commit=1;
SET GLOBAL debug_dbug="+d,ib_log_corrupt_option_crc";
INSERT INTO t VALUES (2);
INSERT INTO t_page_comp VALUES (2);
INSERT INTO t_rf_comp VALUES (2);
INSERT INTO t_enc VALUES (2);
INSERT INTO t_enc_page_comp VALUES (2);
INSERT INTO t_enc_rf_comp VALUES (2);
--source include/kill_mysqld.inc
--source include/start_mysqld.inc
--let SEARCH_FILE=$MYSQLTEST_VARDIR/log/mysqld.1.err
--let SEARCH_PATTERN=Page checksum stored in redo log record
--source include/search_pattern_in_file.inc

DROP TABLE t;
DROP TABLE t_page_comp;
DROP TABLE t_rf_comp;
DROP TABLE t_enc;
DROP TABLE t_enc_page_comp;
DROP TABLE t_enc_rf_comp;

--dec $i
}
