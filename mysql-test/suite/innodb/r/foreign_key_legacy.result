set default_storage_engine= innodb;
call mtr.add_suppression("Couldn't repair table:");
set @saved_debug_dbug= @@session.debug_dbug;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `fk_t2` (`y`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
flush tables;
# Data is imported from SYS_FOREIGN[_COLS] on table open
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `fk_t2` (`y`),
  CONSTRAINT `t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
flush tables;
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails ((null))
drop tables t2, t1;
# DROP TABLE
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails
drop tables t2, t1;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
# DROP DATABASE
create database D1;
create database D2;
create or replace table D1.t1(x int primary key);
set session debug_dbug= "+d,fk_skip_store";
create or replace table D2.t2(y int references D1.t1(x));
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('D2/t2_ibfk_1', 'D2/t2', 'D1/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('D2/t2_ibfk_1', 0, 'y', 'x');";
check table D1.t1, D2.t2;
Table	Op	Msg_type	Msg_text
D1.t1	check	status	OK
D2.t2	check	Note	Found 1 foreign keys
D2.t2	check	status	OK
drop database D1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (t2_ibfk_1)
check table D1.t1, D2.t2;
Table	Op	Msg_type	Msg_text
D1.t1	check	Note	Found 1 referenced keys
D1.t1	check	status	OK
D2.t2	check	Note	Found 1 foreign keys
D2.t2	check	status	OK
drop database D2;
check table D1.t1, D2.t2;
Table	Op	Msg_type	Msg_text
D1.t1	check	status	OK
D2.t2	check	Error	Table 'D2.t2' doesn't exist
D2.t2	check	status	Operation failed
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
drop database D1;
# Index errors
create or replace table t1(x int primary key);
create or replace table t2(y int);
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
flush tables;
show create table t2;
ERROR HY000: Index for table 't2' is corrupt; try to repair it
show warnings;
Level	Code	Message
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
Warning	150	Upgrade table t2 with foreign key t2_ibfk_1 constraint failed. Foreign key index not found!
Error	1215	Cannot add foreign key constraint for `t2`
Error	1034	Index for table 't2' is corrupt; try to repair it
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
show create table t2;
ERROR HY000: Index for table 't2' is corrupt; try to repair it
show warnings;
Level	Code	Message
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
Warning	150	Upgrade table t2 with foreign key t2_ibfk_1 constraint failed. Referenced key index not found!
Error	1215	Cannot add foreign key constraint for `t2`
Error	1034	Index for table 't2' is corrupt; try to repair it
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(z int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
show create table t2;
ERROR HY000: Index for table 't2' is corrupt; try to repair it
show warnings;
Level	Code	Message
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
Warning	150	Upgrade table t2 with foreign key t2_ibfk_1 constraint failed. Foreign key index not found!
Error	1215	Cannot add foreign key constraint for `t2`
Error	1034	Index for table 't2' is corrupt; try to repair it
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(z int primary key);
create or replace table t2(y int references t1(z));
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
show create table t2;
ERROR HY000: Index for table 't2' is corrupt; try to repair it
show warnings;
Level	Code	Message
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
Warning	150	Upgrade table t2 with foreign key t2_ibfk_1 constraint failed. Referenced key index not found!
Error	1215	Cannot add foreign key constraint for `t2`
Error	1034	Index for table 't2' is corrupt; try to repair it
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
drop tables t2, t1;
# Rename of tables (RENAME TABLE)
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
rename table t1 to t0;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t0	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `fk_t2` (`y`),
  CONSTRAINT `t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t0` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
drop table t0;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (t2_ibfk_1)
drop tables t2, t0;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
rename table t2 to t3;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t3_ibfk_1	test/t3	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t3_ibfk_1	y	x	0
show create table t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `y` int(11) DEFAULT NULL,
  KEY `fk_t2` (`y`),
  CONSTRAINT `t3_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (t3_ibfk_1)
drop tables t3, t1;
# Rename of tables (ALTER TABLE .. RENAME)
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
alter table t1 rename t0;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t0	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	x	0
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `fk_t2` (`y`),
  CONSTRAINT `t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t0` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
drop tables t2, t0;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
alter table t2 rename t3;
Warnings:
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
show create table t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `y` int(11) DEFAULT NULL,
  KEY `fk_t2` (`y`),
  CONSTRAINT `t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (t2_ibfk_1)
drop tables t3, t1;
# Rename of columns (ALTER TABLE .. CHANGE)
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
alter table t1 change x z int;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	z	0
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `fk_t2` (`y`),
  CONSTRAINT `t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`z`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
alter table t2 change y z int;
Warnings:
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `z` int(11) DEFAULT NULL,
  KEY `fk_t2` (`z`),
  CONSTRAINT `t2_ibfk_1` FOREIGN KEY (`z`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (t2_ibfk_1)
drop tables t2, t1;
# Rename of columns (ALTER TABLE .. RENAME COLUMN)
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
alter table t1 rename column x to z;
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
test/t2_ibfk_1	test/t2	test/t1	1	0
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
test/t2_ibfk_1	y	z	0
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `y` int(11) DEFAULT NULL,
  KEY `fk_t2` (`y`),
  CONSTRAINT `t2_ibfk_1` FOREIGN KEY (`y`) REFERENCES `t1` (`z`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (t2_ibfk_1)
drop tables t2, t1;
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(x int primary key);
create or replace table t2(y int references t1(x));
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
alter table t2 rename column y to z;
Warnings:
Note	1459	Upgrade required. Please do "REPAIR TABLE `t2`" or dump/reload to fix it!
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `z` int(11) DEFAULT NULL,
  KEY `fk_t2` (`z`),
  CONSTRAINT `t2_ibfk_1` FOREIGN KEY (`z`) REFERENCES `t1` (`x`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (t2_ibfk_1)
drop tables t2, t1;
# Drop column
set session debug_dbug= "+d,fk_skip_store";
create or replace table t1(a int primary key, x int unique);
create or replace table t2(y int references t1(x), b int);
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql="BEGIN
INSERT INTO SYS_FOREIGN VALUES ('test/t2_ibfk_1', 'test/t2', 'test/t1', 1);
INSERT INTO SYS_FOREIGN_COLS VALUES ('test/t2_ibfk_1', 0, 'y', 'x');";
alter table t1 drop column x, algorithm=copy;
ERROR HY000: Can't create table `test`.`t1` (errno: 197 "Table requires foreign keys upgrade")
alter table t1 change x x char(10);
ERROR HY000: Can't create table `test`.`t1` (errno: 197 "Table requires foreign keys upgrade")
alter table t1 drop column x;
ERROR HY000: Cannot drop index 'x': needed in a foreign key constraint
alter table t2 drop column y;
ERROR HY000: Cannot drop index 'fk_t2': needed in a foreign key constraint
select * from information_schema.innodb_sys_foreign;
ID	FOR_NAME	REF_NAME	N_COLS	TYPE
select * from information_schema.innodb_sys_foreign_cols;
ID	FOR_COL_NAME	REF_COL_NAME	POS
drop table t1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (t2_ibfk_1)
drop tables t2, t1;
set session debug_dbug= @saved_debug_dbug;
set global innodb_eval_sql= default;
set default_storage_engine= default;
