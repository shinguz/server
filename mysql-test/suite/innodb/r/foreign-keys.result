#
# Bug #19471516 SERVER CRASHES WHEN EXECUTING ALTER TABLE
# ADD FOREIGN KEY
#
CREATE TABLE `department` (`department_id` INT, `department_people_fk` INT,
PRIMARY KEY (`department_id`)) engine=innodb;
CREATE TABLE `title` (`title_id` INT, `title_manager_fk` INT,
`title_reporter_fk` INT, PRIMARY KEY (`title_id`)) engine=innodb;
CREATE TABLE `people` (`people_id` INT, PRIMARY KEY (`people_id`)) engine=innodb;
ALTER TABLE `department` ADD FOREIGN KEY (`department_people_fk`) REFERENCES
`people` (`people_id`);
ALTER TABLE `title` ADD FOREIGN KEY (`title_manager_fk`) REFERENCES `people`
(`people_id`);
ALTER TABLE `title` ADD FOREIGN KEY (`title_reporter_fk`) REFERENCES `people`
(`people_id`);
drop table title, department, people;
create table t1 (a int primary key, b int) engine=innodb;
create table t2 (c int primary key, d int,
foreign key (d) references t1 (a) on update cascade) engine=innodb;
insert t1 values (1,1),(2,2),(3,3);
insert t2 values (4,1),(5,2),(6,3);
flush table t2 with read lock;
connect  con1,localhost,root;
delete from t1 where a=2;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (`test`.`t2`, CONSTRAINT `fk_t2` FOREIGN KEY (`d`) REFERENCES `t1` (`a`) ON UPDATE CASCADE)
update t1 set a=10 where a=1;
connection default;
unlock tables;
connection con1;
connection default;
lock table t2 write;
connection con1;
delete from t1 where a=2;
connection default;
unlock tables;
connection con1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (`test`.`t2`, CONSTRAINT `fk_t2` FOREIGN KEY (`d`) REFERENCES `t1` (`a`) ON UPDATE CASCADE)
connection default;
unlock tables;
disconnect con1;
create user foo;
grant select,update on test.t1 to foo;
connect foo,localhost,foo;
update t1 set a=30 where a=3;
disconnect foo;
connection default;
select * from t2;
c	d
5	2
4	10
6	30
drop table t2, t1;
drop user foo;
create table t1 (f1 int primary key) engine=innodb;
create table t2 (f2 int primary key) engine=innodb;
create table t3 (f3 int primary key, foreign key (f3) references t2(f2)) engine=innodb;
insert into t1 values (1),(2),(3),(4),(5);
insert into t2 values (1),(2),(3),(4),(5);
insert into t3 values (1),(2),(3),(4),(5);
connect con1,localhost,root;
set debug_sync='alter_table_before_rename_result_table signal g1 wait_for g2';
alter table t2 add constraint foreign key (f2) references t1(f1) on delete cascade on update cascade;
connection default;
set debug_sync='before_execute_sql_command wait_for g1';
update t1 set f1 = f1 + 100000 limit 2;
connect con2,localhost,root;
kill query UPDATE;
disconnect con2;
connection default;
ERROR 70100: Query execution was interrupted
set debug_sync='now signal g2';
connection con1;
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `f2` int(11) NOT NULL,
  PRIMARY KEY (`f2`),
  CONSTRAINT `fk_t2` FOREIGN KEY (`f2`) REFERENCES `t1` (`f1`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1
disconnect con1;
connection default;
select * from t2 where f2 not in (select f1 from t1);
f2
select * from t3 where f3 not in (select f2 from t2);
f3
drop table t3;
drop table t2;
drop table t1;
set debug_sync='reset';
#
# MDEV-17595 - Server crashes in copy_data_between_tables or
#              Assertion `thd->transaction.stmt.is_empty() ||
#              (thd->state_flags & Open_tables_state::BACKUPS_AVAIL)'
#              fails in close_tables_for_reopen upon concurrent
#              ALTER TABLE and FLUSH
#
CREATE TABLE t1 (a INT, KEY(a)) ENGINE=InnoDB;
INSERT INTO t1 VALUES(1),(2);
CREATE TABLE t2 (b INT, KEY(b)) ENGINE=InnoDB;
INSERT INTO t2 VALUES(2);
ALTER TABLE t2 ADD FOREIGN KEY(b) REFERENCES t1(a), LOCK=EXCLUSIVE;
DROP TABLE t2, t1;
#
# MDEV-16060 - InnoDB: Failing assertion: ut_strcmp(index->name, key->name)
#
CREATE TABLE t1 (`pk` INT PRIMARY KEY) ENGINE=InnoDB;
CREATE TABLE t2 LIKE t1;
FLUSH TABLES;
SET debug_sync='alter_table_intermediate_table_created SIGNAL ready WAIT_FOR go';
ALTER TABLE t1 ADD FOREIGN KEY(pk) REFERENCES t2(pk) ON UPDATE CASCADE;
connect con1, localhost, root;
SET debug_sync='now WAIT_FOR ready';
SET lock_wait_timeout=0;
UPDATE t2 SET pk=10 WHERE pk=1;
ERROR HY000: Lock wait timeout exceeded; try restarting transaction
PREPARE stmt FROM 'UPDATE t2 SET pk=10 WHERE pk=1';
DEALLOCATE PREPARE stmt;
SET debug_sync='now SIGNAL go';
connection default;
disconnect con1;
connection default;
SET debug_sync='reset';
SHOW OPEN TABLES FROM test;
Database	Table	In_use	Name_locked
test	t2	0	0
DROP TABLE t1, t2;
create table t1 (a int primary key, b int) engine=innodb;
create table t2 (c int primary key, d int,
foreign key (d) references t1 (a) on update cascade) engine=innodb;
insert t1 values (1,1),(2,2),(3,3);
insert t2 values (4,1),(5,2),(6,3);
flush table t2 with read lock;
connect  con1,localhost,root;
delete from t1 where a=2;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (`test`.`t2`, CONSTRAINT `fk_t2` FOREIGN KEY (`d`) REFERENCES `t1` (`a`) ON UPDATE CASCADE)
update t1 set a=10 where a=1;
connection default;
unlock tables;
connection con1;
connection default;
lock table t2 write;
connection con1;
delete from t1 where a=2;
connection default;
unlock tables;
connection con1;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (`test`.`t2`, CONSTRAINT `fk_t2` FOREIGN KEY (`d`) REFERENCES `t1` (`a`) ON UPDATE CASCADE)
connection default;
unlock tables;
disconnect con1;
create user foo;
grant select,update on test.t1 to foo;
connect foo,localhost,foo;
update t1 set a=30 where a=3;
disconnect foo;
connection default;
select * from t2;
c	d
5	2
4	10
6	30
drop table t2, t1;
drop user foo;
#
# MDEV-17187 table doesn't exist in engine after ALTER other tables
# with CONSTRAINTs
#
set foreign_key_checks=on;
create table t1 (id int not null primary key) engine=innodb;
create table t2 (id int not null primary key, fid int not null,
CONSTRAINT fk_fid FOREIGN KEY (fid) REFERENCES t1 (id))engine=innodb;
insert into t1 values (1), (2), (3);
insert into t2 values (1, 1), (2, 1), (3, 2);
set foreign_key_checks=off;
alter table t2 drop index fk_fid;
set foreign_key_checks=on;
delete from t1 where id=2;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (`test`.`t2`, CONSTRAINT `fk_fid` FOREIGN KEY (`fid`) REFERENCES `t1` (`id`))
insert into t2 values(4, 99);
ERROR 23000: Cannot add or update a child row: a foreign key constraint fails (`test`.`t2`, CONSTRAINT `fk_fid` FOREIGN KEY (`fid`) REFERENCES `t1` (`id`))
select * from t1;
id
1
2
3
select * from t2;
id	fid
1	1
2	1
3	2
set foreign_key_checks=off;
delete from t1 where id=2;
insert into t2 values(4, 99);
set foreign_key_checks=on;
select * from t1;
id
1
3
select * from t2;
id	fid
1	1
2	1
3	2
4	99
show create table t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int(11) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
show create table t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `id` int(11) NOT NULL,
  `fid` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  CONSTRAINT `fk_fid` FOREIGN KEY (`fid`) REFERENCES `t1` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
drop table t1,t2;
ERROR 23000: Cannot delete or update a parent row: a foreign key constraint fails (fk_fid)
drop table t2, t1;
#
# MDEV-21053 Crash safety of foreign key DDL
#
call mtr.add_suppression("Failed to execute action for entry");
create or replace procedure make_tables()
begin
create table t1 (x int primary key, a int references t1(x));
create table t2 (x int references t1(x), y int primary key, b int references t2(x));
create table t3 (x int references t2(x), y int references t2(y), z int primary key, c int references t3(z));
create table t4 (
a int primary key,
x int references t1(x),
y int references t2(y),
z int references t3(z));
insert t1 values (1, 1);
insert t2 values (1, 2, 1);
insert t3 values (1, 2, 3, 3);
insert t4 values (0, 1, 2, 3);
end $
create or replace procedure drop_tables()
begin
drop table if exists t4;
drop table if exists t3;
drop table if exists t2;
drop table if exists t1;
end $
# DROP TABLE
call make_tables;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_write_shadow_frm";
drop tables t4, t1, t3, t2;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_backup_frm";
drop tables t4, t1, t3, t2;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_install_shadow_frm";
drop tables t4, t1, t3, t2;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_write_shadow_frm";
drop tables t4, t1, t3, t2;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sqlf-shadow-t2.frm
#sqlf-shadow-t3.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
# State after crash recovery
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_backup_frm";
drop tables t4, t1, t3, t2;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sqlf-shadow-t1.frm
#sqlf-shadow-t2.frm
#sqlf-shadow-t3.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.fbk
t3.MYD
t3.MYI
t3.fbk
t4.MYD
t4.MYI
t4.frm
# State after crash recovery
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_install_shadow_frm";
drop tables t4, t1, t3, t2;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sqlf-shadow-t1.frm
db.opt
t1.MYD
t1.MYI
t1.fbk
t2.MYD
t2.MYI
t2.fbk
t2.frm
t3.MYD
t3.MYI
t3.fbk
t3.frm
t4.MYD
t4.MYI
t4.frm
# State after crash recovery
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
call drop_tables;
# CREATE TABLE
create table t1 (x int primary key);
create table t2 (y int primary key);
create table t3 (z int primary key);
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
set @@debug_dbug= "+d,fail_fk_write_shadow_frm";
create table t4 (a int primary key, x int references t1(x), y int references t2(y), z int references t3(z));
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
set @@debug_dbug= "+d,fail_fk_backup_frm";
create table t4 (a int primary key, x int references t1(x), y int references t2(y), z int references t3(z));
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
set @@debug_dbug= "+d,fail_fk_backup_frm";
create table t4 (a int primary key, x int references t1(x), y int references t2(y), z int references t3(z));
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
set @@debug_dbug= "+d,fail_fk_install_shadow_frm";
create table t4 (a int primary key, x int references t1(x), y int references t2(y), z int references t3(z));
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
set @@debug_dbug= "+d,crash_fk_write_shadow_frm";
create table t4 (a int primary key, x int references t1(x), y int references t2(y), z int references t3(z));
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sqlf-shadow-t2.frm
#sqlf-shadow-t3.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.frm
# State after crash recovery
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Can't find file: './test/t4.MYI' (errno: 2 "No such file or directory")
test.t4	check	status	Operation failed
set session debug_dbug=@save_dbug;
drop table t4;
Warnings:
Warning	1017	Can't find file: './test/t4.MYI' (errno: 2 "No such file or directory")
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
set @@debug_dbug= "+d,crash_fk_backup_frm";
create table t4 (a int primary key, x int references t1(x), y int references t2(y), z int references t3(z));
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sqlf-shadow-t1.frm
#sqlf-shadow-t2.frm
#sqlf-shadow-t3.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.fbk
t3.MYD
t3.MYI
t3.fbk
t4.frm
# State after crash recovery
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Can't find file: './test/t4.MYI' (errno: 2 "No such file or directory")
test.t4	check	status	Operation failed
set session debug_dbug=@save_dbug;
drop table t4;
Warnings:
Warning	1017	Can't find file: './test/t4.MYI' (errno: 2 "No such file or directory")
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Table 'test.t4' doesn't exist
test.t4	check	status	Operation failed
set @@debug_dbug= "+d,crash_fk_install_shadow_frm";
create table t4 (a int primary key, x int references t1(x), y int references t2(y), z int references t3(z));
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sqlf-shadow-t1.frm
db.opt
t1.MYD
t1.MYI
t1.fbk
t2.MYD
t2.MYI
t2.fbk
t2.frm
t3.MYD
t3.MYI
t3.fbk
t3.frm
t4.frm
# State after crash recovery
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	status	OK
test.t2	check	status	OK
test.t3	check	status	OK
test.t4	check	Error	Can't find file: './test/t4.MYI' (errno: 2 "No such file or directory")
test.t4	check	status	Operation failed
set session debug_dbug=@save_dbug;
call drop_tables;
# RENAME TABLE
call make_tables;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_write_shadow_frm";
rename table t4 to xt4, t1 to xt1, t3 to xt3, t2 to xt2;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_backup_frm";
rename table t4 to xt4, t1 to xt1, t3 to xt3, t2 to xt2;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_install_shadow_frm";
rename table t4 to xt4, t1 to xt1, t3 to xt3, t2 to xt2;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_write_shadow_frm";
rename table t4 to xt4, t1 to xt1, t3 to xt3, t2 to xt2;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sqlf-shadow-xt2.frm
#sqlf-shadow-xt3.frm
#sqlf-shadow-xt4.frm
db.opt
xt1.MYD
xt1.MYI
xt1.frm
xt2.MYD
xt2.MYI
xt2.frm
xt3.MYD
xt3.MYI
xt3.frm
xt4.MYD
xt4.MYI
xt4.frm
# State after crash recovery
db.opt
xt1.MYD
xt1.MYI
xt1.frm
xt2.MYD
xt2.MYI
xt2.frm
xt3.MYD
xt3.MYI
xt3.frm
xt4.MYD
xt4.MYI
xt4.frm
set foreign_key_checks= 0;
rename table xt4 to t4, xt3 to t3, xt2 to t2, xt1 to t1;
set foreign_key_checks= 1;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_backup_frm";
rename table t4 to xt4, t1 to xt1, t3 to xt3, t2 to xt2;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sqlf-shadow-xt1.frm
#sqlf-shadow-xt2.frm
#sqlf-shadow-xt3.frm
#sqlf-shadow-xt4.frm
db.opt
xt1.MYD
xt1.MYI
xt1.frm
xt2.MYD
xt2.MYI
xt2.fbk
xt3.MYD
xt3.MYI
xt3.fbk
xt4.MYD
xt4.MYI
xt4.fbk
# State after crash recovery
db.opt
xt1.MYD
xt1.MYI
xt1.frm
xt2.MYD
xt2.MYI
xt2.frm
xt3.MYD
xt3.MYI
xt3.frm
xt4.MYD
xt4.MYI
xt4.frm
set foreign_key_checks= 0;
rename table xt4 to t4, xt3 to t3, xt2 to t2, xt1 to t1;
set foreign_key_checks= 1;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_install_shadow_frm";
rename table t4 to xt4, t1 to xt1, t3 to xt3, t2 to xt2;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sqlf-shadow-xt1.frm
db.opt
xt1.MYD
xt1.MYI
xt1.fbk
xt2.MYD
xt2.MYI
xt2.fbk
xt2.frm
xt3.MYD
xt3.MYI
xt3.fbk
xt3.frm
xt4.MYD
xt4.MYI
xt4.fbk
xt4.frm
# State after crash recovery
db.opt
xt1.MYD
xt1.MYI
xt1.frm
xt2.MYD
xt2.MYI
xt2.frm
xt3.MYD
xt3.MYI
xt3.frm
xt4.MYD
xt4.MYI
xt4.frm
set foreign_key_checks= 0;
rename table xt4 to t4, xt3 to t3, xt2 to t2, xt1 to t1;
set foreign_key_checks= 1;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_write_shadow_frm";
alter table t3 rename xt3;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_backup_frm";
alter table t3 rename xt3;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_install_shadow_frm";
alter table t3 rename xt3;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_write_shadow_frm";
alter table t3 rename xt3;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sqlf-shadow-t4.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
# State after crash recovery
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_backup_frm";
alter table t3 rename xt3;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sqlf-shadow-t2.frm
#sqlf-shadow-t4.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.fbk
# State after crash recovery
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_install_shadow_frm";
alter table t3 rename xt3;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sqlf-shadow-t2.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.fbk
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.fbk
t4.frm
# State after crash recovery
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
call drop_tables;
# RENAME COLUMN
call make_tables;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_write_shadow_frm";
alter table t2 change y z int, change x y int, change b c int;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_backup_frm";
alter table t2 change y z int, change x y int, change b c int;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_install_shadow_frm";
alter table t2 change y z int, change x y int, change b c int;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_write_shadow_frm";
alter table t2 change y z int, change x y int, change b c int;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sql-alter-3.frm
#sqlf-shadow-t4.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
# State after crash recovery
#sql-alter-3.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_backup_frm";
alter table t2 change y z int, change x y int, change b c int;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sql-alter-3.frm
#sqlf-shadow-t3.frm
#sqlf-shadow-t4.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.fbk
# State after crash recovery
#sql-alter-3.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_install_shadow_frm";
alter table t2 change y z int, change x y int, change b c int;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sql-alter-3.frm
#sqlf-shadow-t3.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.fbk
t4.MYD
t4.MYI
t4.fbk
t4.frm
# State after crash recovery
#sql-alter-3.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_write_shadow_frm";
alter table t3 rename column z to z2, rename column y to y2, rename column x to x2, rename column c to c2;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_backup_frm";
alter table t3 rename column z to z2, rename column y to y2, rename column x to x2, rename column c to c2;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_install_shadow_frm";
alter table t3 rename column z to z2, rename column y to y2, rename column x to x2, rename column c to c2;
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_write_shadow_frm";
alter table t3 rename column z to z2, rename column y to y2, rename column x to x2, rename column c to c2;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sql-alter-3.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
# State after crash recovery
#sql-alter-3.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_backup_frm";
alter table t3 rename column z to z2, rename column y to y2, rename column x to x2, rename column c to c2;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sql-alter-3.frm
#sqlf-shadow-t4.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
# State after crash recovery
#sql-alter-3.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_install_shadow_frm";
alter table t3 rename column z to z2, rename column y to y2, rename column x to x2, rename column c to c2;
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sql-alter-3.frm
#sqlf-shadow-t4.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.fbk
# State after crash recovery
#sql-alter-3.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
call drop_tables;
# ADD/DROP FOREIGN KEY, DROP COLUMN
call make_tables;
show create table t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `x` int(11) DEFAULT NULL,
  `y` int(11) DEFAULT NULL,
  `z` int(11) NOT NULL,
  `c` int(11) DEFAULT NULL,
  PRIMARY KEY (`z`),
  KEY `fk_t3` (`x`),
  KEY `fk_t3_2` (`y`),
  KEY `fk_t3_3` (`c`),
  CONSTRAINT `fk_t3` FOREIGN KEY (`x`) REFERENCES `t2` (`x`),
  CONSTRAINT `fk_t3_2` FOREIGN KEY (`y`) REFERENCES `t2` (`y`),
  CONSTRAINT `fk_t3_3` FOREIGN KEY (`c`) REFERENCES `t3` (`z`)
) ENGINE=MyISAM DEFAULT CHARSET=latin1
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_write_shadow_frm";
alter table t3
drop foreign key fk_t3,
drop foreign key fk_t3_2,
drop foreign key fk_t3_3,
drop c,
add foreign key (x) references t1(x),
add foreign key (y) references t2(x);
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_backup_frm";
alter table t3
drop foreign key fk_t3,
drop foreign key fk_t3_2,
drop foreign key fk_t3_3,
drop c,
add foreign key (x) references t1(x),
add foreign key (y) references t2(x);
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,fail_fk_install_shadow_frm";
alter table t3
drop foreign key fk_t3,
drop foreign key fk_t3_2,
drop foreign key fk_t3_3,
drop c,
add foreign key (x) references t1(x),
add foreign key (y) references t2(x);
ERROR HY000: Unknown error
# State after failure
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
set @save_dbug=@@debug_dbug;
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
# State before crash
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set @@debug_dbug= "+d,crash_fk_write_shadow_frm";
alter table t3
drop foreign key fk_t3,
drop foreign key fk_t3_2,
drop foreign key fk_t3_3,
drop c,
add foreign key (x) references t1(x),
add foreign key (y) references t2(x);
ERROR HY000: Lost connection to MySQL server during query
# State after crash (before recovery)
#sql-alter-3.MYD
#sql-alter-3.MYI
#sql-alter-3.frm
#sqlf-shadow-t2.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
# State after crash recovery
#sql-alter-3.MYD
#sql-alter-3.MYI
#sql-alter-3.frm
db.opt
t1.MYD
t1.MYI
t1.frm
t2.MYD
t2.MYI
t2.frm
t3.MYD
t3.MYI
t3.frm
t4.MYD
t4.MYI
t4.frm
check tables t1, t2, t3, t4;
Table	Op	Msg_type	Msg_text
test.t1	check	Note	Found 2 referenced keys
test.t1	check	Note	Found 1 self-references
test.t1	check	status	OK
test.t2	check	Note	Found 3 referenced keys
test.t2	check	Note	Found 1 foreign keys
test.t2	check	Note	Found 1 self-references
test.t2	check	status	OK
test.t3	check	Note	Found 1 referenced keys
test.t3	check	Note	Found 2 foreign keys
test.t3	check	Note	Found 1 self-references
test.t3	check	status	OK
test.t4	check	Note	Found 3 foreign keys
test.t4	check	status	OK
set session debug_dbug=@save_dbug;
call drop_tables;
drop procedure make_tables;
drop procedure drop_tables;
set session debug_dbug=@save_dbug;
